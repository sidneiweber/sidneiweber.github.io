<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=pt-br><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Ansible: Criado AMI Windows personalizada na AWS (Parte 2) - Sidnei Weber</title><meta name=author content="Sidnei Weber"><meta name=author-link content><meta name=description content="Na [parte 1](https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/) aprendemos como usar um script AWS User Data para configurar uma senha de Administrador e configurar o WinRM no Windows. Agora que sabemos como criar uma instância setando um senha especifica, vamos ao restante dos procedimentos.  Vamos estruturar nosso projeto e manter as coisas organizadas."><meta name=keywords content="aws,ansible,windows"><meta itemprop=name content="Ansible: Criado AMI Windows personalizada na AWS (Parte 2)"><meta itemprop=description content="Na [parte 1](https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/) aprendemos como usar um script AWS User Data para configurar uma senha de Administrador e configurar o WinRM no Windows. Agora que sabemos como criar uma instância setando um senha especifica, vamos ao restante dos procedimentos.  Vamos estruturar nosso projeto e manter as coisas organizadas."><meta itemprop=datePublished content="2019-12-27T17:04:43+00:00"><meta itemprop=dateModified content="2019-12-27T17:04:43+00:00"><meta itemprop=wordCount content="1184"><meta itemprop=image content="https://sidneiweber.com.br/logo.png"><meta itemprop=keywords content="aws,ansible,windows,"><meta property="og:title" content="Ansible: Criado AMI Windows personalizada na AWS (Parte 2)"><meta property="og:description" content="Na [parte 1](https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/) aprendemos como usar um script AWS User Data para configurar uma senha de Administrador e configurar o WinRM no Windows. Agora que sabemos como criar uma instância setando um senha especifica, vamos ao restante dos procedimentos.  Vamos estruturar nosso projeto e manter as coisas organizadas."><meta property="og:type" content="article"><meta property="og:url" content="https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-2/"><meta property="og:image" content="https://sidneiweber.com.br/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-27T17:04:43+00:00"><meta property="article:modified_time" content="2019-12-27T17:04:43+00:00"><meta property="og:site_name" content="Sidnei Weber"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sidneiweber.com.br/logo.png"><meta name=twitter:title content="Ansible: Criado AMI Windows personalizada na AWS (Parte 2)"><meta name=twitter:description content="Na [parte 1](https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/) aprendemos como usar um script AWS User Data para configurar uma senha de Administrador e configurar o WinRM no Windows. Agora que sabemos como criar uma instância setando um senha especifica, vamos ao restante dos procedimentos.  Vamos estruturar nosso projeto e manter as coisas organizadas."><meta name=application-name content="Sidnei Weber"><meta name=apple-mobile-web-app-title content="Sidnei Weber"><meta name=theme-color data-light=#ffffff data-dark=#ffffff content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-2/><link rel=prev href=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/><link rel=next href=https://sidneiweber.com.br/como-redimensionar-volume-ebs-no-linux-sem-downtime/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Ansible: Criado AMI Windows personalizada na AWS (Parte 2)","inLanguage":"pt-br","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/sidneiweber.com.br\/ansible-criado-ami-windows-personalizada-na-aws-parte-2\/"},"image":["https:\/\/sidneiweber.com.br\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"aws, ansible, windows","wordcount":1184,"url":"https:\/\/sidneiweber.com.br\/ansible-criado-ami-windows-personalizada-na-aws-parte-2\/","datePublished":"2019-12-27T17:04:43+00:00","dateModified":"2019-12-27T17:04:43+00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/sidneiweber.com.br\/images\/avatar.png"},"author":{"@type":"Person","name":"Sidnei Weber"},"description":"Na [parte 1](https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/) aprendemos como usar um script AWS User Data para configurar uma senha de Administrador e configurar o WinRM no Windows. Agora que sabemos como criar uma instância setando um senha especifica, vamos ao restante dos procedimentos.  Vamos estruturar nosso projeto e manter as coisas organizadas."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Sidnei Weber"><span class=header-title-pre><i class='fas fa-user-astronaut fa-fw' aria-hidden=true></i></span><span id=typeit-header-desktop class=typeit></span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-tent fa-fw fa-sm" aria-hidden=true></i> Artigos</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class="menu-item has-children"><a class=menu-link href=/#><i class="fa-solid fa-screwdriver-wrench fa-fw fa-sm" aria-hidden=true></i> Ferramentas</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/gerador-senhas/><i class="fa-solid fa-lock fa-fw fa-sm" aria-hidden=true></i> Gerador de senhas</a></li></ul></li><li class=menu-item><a class=menu-link href=/guia-rapido/><i class="fa-solid fa-truck-fast fa-fw fa-sm" aria-hidden=true></i> Guia Rápido</a></li><li class=menu-item><a class=menu-link href=/sobre/><i class="fa-solid fa-user fa-fw fa-sm" aria-hidden=true></i> Sobre</a></li><li class=menu-item><a class=menu-link href=https://github.com/sidneiweber title=GitHub rel="noopener noreferrer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="Pesquisar títulos ou conteúdos ..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Pesquisa><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Limpar><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title="Trocar tema"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li><li class="menu-item language-switch"><span role=button aria-label="Selecione o idioma" title="Selecione o idioma"><i class="fa-solid fa-language fa-fw" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item>Não há mais traduções</li></ul></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Sidnei Weber"><span class=header-title-pre><i class='fas fa-user-astronaut fa-fw' aria-hidden=true></i></span><span id=typeit-header-title-mobile class=typeit></span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Pesquisar títulos ou conteúdos ..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Pesquisa><i class="fa-solid fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Limpar><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancelar</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-tent fa-fw fa-sm" aria-hidden=true></i> Artigos</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/#><i class="fa-solid fa-screwdriver-wrench fa-fw fa-sm" aria-hidden=true></i> Ferramentas</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/gerador-senhas/><i class="fa-solid fa-lock fa-fw fa-sm" aria-hidden=true></i> Gerador de senhas</a></li></ul></li><li class=menu-item><a class=menu-link href=/guia-rapido/><i class="fa-solid fa-truck-fast fa-fw fa-sm" aria-hidden=true></i> Guia Rápido</a></li><li class=menu-item><a class=menu-link href=/sobre/><i class="fa-solid fa-user fa-fw fa-sm" aria-hidden=true></i> Sobre</a></li><li class=menu-item><a class=menu-link href=https://github.com/sidneiweber title=GitHub rel="noopener noreferrer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title="Trocar tema"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span><span class="menu-system-item language-switch">
<span role=button aria-label="Selecione o idioma" title="Selecione o idioma">Português<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i></span>
<select class=language-select onchange="location=this.value"><option disabled>Não há mais traduções</option></select></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class=toc id=toc-auto></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Ansible: Criado AMI Windows personalizada na AWS (Parte 2)</span></h1><p class="single-subtitle animate__animated animate__fadeIn">Criando Windows personalizado e gerando AMI com Ansible</p></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
Sidnei Weber</span></span></div><div class=post-meta-line><span title="publicado em 2019-12-27 17:04:43"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=27/12/2019>27/12/2019</time></span>&nbsp;<span title="Atualizado em 2019-12-27 17:04:43"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=27/12/2019>27/12/2019</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>1184 palavras</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>6 minutos</span>&nbsp;</div></div><div class=content id=content><p>Na <a href=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/ target=_blank rel="external nofollow noopener noreferrer">parte 1</a> aprendemos como usar um script AWS User Data para configurar uma senha de Administrador e configurar o WinRM no Windows. Agora que sabemos como criar uma instância setando um senha especifica, vamos ao restante dos procedimentos. Vamos estruturar nosso projeto e manter as coisas organizadas.</p><p>Recursos utilizados, caso não tenha algo instalado, não funcionará :</p><p><strong>Python 3.8.0</strong><br><strong>Módulos pip</strong>:<br></p><ul><li>boto<br></li><li>boto3<br></li><li>pywinrm</li></ul><p><strong>Ansible 2.9.2</strong></p><p>Já podemos supor que você tenha o Ansible configurado corretamente para sua conta da AWS (por exemplo, boto instalado, credenciais do IAM configuradas). Consulte o Guia da AWS da Ansible se precisar de ajuda para fazer isso. Por simplicidade, esses exemplos também pressupõem que você tenha uma VPC padrão funcional em sua região (você deve ter, a menos que a tenha excluído). Se você precisar de ajuda para configurar isso, consulte a página da Amazon em VPCs padrão.</p><p>Caso queira ir direto para os arquivos usados, pode acessar no github: <a href=https://github.com/sidneiweber/ansible-windows-ami target=_blank rel="external nofollow noopener noreferrer">https://github.com/sidneiweber/ansible-windows-ami</a></p><p>Vamos iniciar pelas nossas variáveis, onde vamos setar a região da AWS, o tipo de instância, nossa chave, vpc e subnet, nossa senha que usamos na <a href=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/ target=_blank rel="external nofollow noopener noreferrer">primeira parte</a> do artigo e alguns detalhes sobre os volumes:</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># cat group_vars/all.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>target_aws_region</span><span class=p>:</span><span class=w> </span><span class=l>us-east-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>instance_type</span><span class=p>:</span><span class=w> </span><span class=l>t3.small</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>keypair</span><span class=p>:</span><span class=w> </span><span class=l>keypair</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>vpc_id</span><span class=p>:</span><span class=w> </span><span class=l>vpc-xxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subnet</span><span class=p>:</span><span class=w> </span><span class=l>subnet-xxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>win_initial_password</span><span class=p>:</span><span class=w> </span><span class=l>myTempPassword123!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>device_name</span><span class=p>:</span><span class=w> </span><span class=l>/dev/sda1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_type</span><span class=p>:</span><span class=w> </span><span class=l>gp2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volume_size</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delete_on_termination</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></td></tr></table></div></div><p>Nosso arquivo hosts ficará assim. O grupo win é onde será adicionada a instância após a criação:<br></p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=l>localhost ansible_connection=local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=l>win]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=l>win:vars]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ansible_connection=winrm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ansible_ssh_port=5986</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ansible_ssh_user=Administrator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ansible_ssh_pass=&#34;{{ win_initial_password }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ansible_winrm_server_cert_validation=ignore</span></span></span></code></pre></td></tr></table></div></div><p>Com essas váriaveis em mãos, vamos iniciar nossa instância base já usando o userdata assim como fizemos no painel da AWS, só que dessa vez diretamente pelo ansible:<br></p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># cat roles/launch/tasks/main.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Find Windows AMI base in this region</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ec2_ami_facts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>owners</span><span class=p>:</span><span class=w> </span><span class=m>801119661308</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>filters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Windows_Server-2019-English-Full-Base*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>found_amis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Get AMI Windows</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>win_ami_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ (found_amis.images | first).image_id  }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ensure security group is present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ec2_group</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>WinRM RDP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Inbound WinRM and RDP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ target_aws_region }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vpc_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ vpc_id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>proto</span><span class=p>:</span><span class=w> </span><span class=l>tcp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>from_port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to_port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cidr_ip</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=l>/0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>proto</span><span class=p>:</span><span class=w> </span><span class=l>tcp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>from_port</span><span class=p>:</span><span class=w> </span><span class=m>5986</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to_port</span><span class=p>:</span><span class=w> </span><span class=m>5986</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cidr_ip</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=l>/0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>proto</span><span class=p>:</span><span class=w> </span><span class=l>tcp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>from_port</span><span class=p>:</span><span class=w> </span><span class=m>3389</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to_port</span><span class=p>:</span><span class=w> </span><span class=m>3389</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cidr_ip</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=l>/0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rules_egress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>proto</span><span class=p>:</span><span class=w> </span>-<span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cidr_ip</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=l>/0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>sg_out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ensure instances are running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ec2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ target_aws_region }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ win_ami_id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instance_type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ instance_type }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ sg_out.group_id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>key_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ keypair }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>wait</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>wait_timeout</span><span class=p>:</span><span class=w> </span><span class=m>500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exact_count</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>assign_public_ip</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vpc_subnet_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ subnet }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>count_tag</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Name</span><span class=p>:</span><span class=w> </span><span class=l>stock-win-ami-test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instance_tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Name</span><span class=p>:</span><span class=w> </span><span class=l>stock-win-ami-test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user_data</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ lookup(&#39;template&#39;, &#39;userdata.txt.j2&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>ec2_result</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>wait for WinRM to answer on all hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wait_for</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5986</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.public_ip }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delay</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>started</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ec2_result.tagged_instances }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>add hosts to groups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>add_host</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;win-temp-{{ item.id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_ssh_host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.public_ip }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ec2_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=l>win</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ec2_result.tagged_instances }}&#34;</span></span></span></code></pre></td></tr></table></div></div><p>Agora vamos conectar na instância e fazer a instalação do que precisamos, vamos contar com auxilio de um script para instalar o Chocolatey e algumas ferramentas (JDK e git) somente para exemplo.<br>Vamos também instalar algumas features do Windows como IIS, Powershell e .NET Framework, também somente para aprendizado. Também usaremos o módulo do Chocolatey para instalar o 7zip.<br></p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># cat roles/deploy/tasks/main.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Copy Script config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>win_copy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>script.ps1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>C:\Windows\Temp\script.ps1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Execute script</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>win_shell</span><span class=p>:</span><span class=w> </span><span class=l>C:\Windows\Temp\script.ps1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure IIS and ASP.NET are installed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>win_feature</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Http-Redirect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-DAV-Publishing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Custom-Logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Log-Libraries</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-ODBC-Logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Request-Monitor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Http-Tracing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Dyn-Compression</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Basic-Auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-CertProvider</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Client-Auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Digest-Auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Cert-Auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-IP-Security</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Url-Auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Windows-Auth</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-App-Dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Net-Ext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Net-Ext45</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Asp-Net45</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-ISAPI-Ext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-ISAPI-Filter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Mgmt-Tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Scripting-Tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Mgmt-Console</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Web-Mgmt-Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET-Framework-Features</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET-Framework-Core</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET-HTTP-Activation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET-Non-HTTP-Activ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET-Framework-45-Features</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET-Framework-45-Core</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET-Framework-45-ASPNET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>NET-WCF-Services45</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MSMQ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MSMQ-Services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>MSMQ-Server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>FS-SMB1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Telnet-Client</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PowerShellRoot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PowerShell</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PowerShell-V2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>PowerShell-ISE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>WAS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>WAS-Process-Model</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>WAS-NET-Environment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>WAS-Config-APIs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>WoW64-Support</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>include_management_tools</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>windows_install</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Reboot if installing Web-Server feature requires it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>win_reboot</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>windows_install.reboot_required</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install 7Zip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>win_chocolatey</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>7zip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=l>web application is available at http://{{ ansible_ssh_host }}/</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># cat roles/deploy/files/script.ps1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Install Chocolatey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>iex ((New-Object System.Net.WebClient).DownloadString(&#39;https://chocolatey.org/install.ps1&#39;))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Globally Auto confirm every action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>choco feature enable -n allowGalobalConfirmation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Install JDK 8 and git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>choco install jdk8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>choco install git</span></span></span></code></pre></td></tr></table></div></div><p>Agora vamos gerar nossa AMI personalizada, lembrando que o nome deve ser sempre diferente ao gerar uma nova AMI, aqui é interessante incluir uma variável com o número do build do seu pipeline por exemplo:<br></p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># cat roles/build-ami/tasks/main.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Create AMI</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ec2_ami</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ target_aws_region }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instance_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ item.id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;windows-personalizado&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>wait</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ec2_result.tagged_instances }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>ami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Set New AMI id variable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ami_result</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ (ami.results | first).image_id  }}&#34;</span></span></span></code></pre></td></tr></table></div></div><p>Para não ficarmos com essa instância base rodando sem necessidade, vamos exclui-la:<br></p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># cat roles/terminate/tasks/main.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure instances are not running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ec2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ target_aws_region }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ win_ami_id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instance_type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ instance_type }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ sg_out.group_id }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>key_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ keypair }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>wait</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>wait_timeout</span><span class=p>:</span><span class=w> </span><span class=m>500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>exact_count</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>assign_public_ip</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>vpc_subnet_id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ subnet }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>count_tag</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Name</span><span class=p>:</span><span class=w> </span><span class=l>stock-win-ami-test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>instance_tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Name</span><span class=p>:</span><span class=w> </span><span class=l>stock-win-ami-test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>ec2_result</span></span></span></code></pre></td></tr></table></div></div><p>Então nosso arquivo principal para realizarmos essa tarega ficará assim:<br></p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># cat deploy.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>launch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>win</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>win</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>deploy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>build-ami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>terminate</span></span></span></code></pre></td></tr></table></div></div><p>E para rodar tudo e ser feliz basta executar: <em><strong>ansible-playbook -i hosts deploy.yml</strong></em></p><p><strong>Iniciando a execução:</strong></p><p><img loading=lazy src=/img/aws-ami/1.png srcset="/img/aws-ami/1.png, /img/aws-ami/1.png 1.5x, /img/aws-ami/1.png 2x" sizes=auto data-title="Iniciando Instância" data-alt="Iniciando Instância" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><strong>Instância rodando na AWS:</strong></p><p><img loading=lazy src=/img/aws-ami/5.png srcset="/img/aws-ami/5.png, /img/aws-ami/5.png 1.5x, /img/aws-ami/5.png 2x" sizes=auto data-title="Instância iniciada" data-alt="Instância iniciada" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><strong>Instalando aplicações e configurações:</strong></p><p><img loading=lazy src=/img/aws-ami/2.png srcset="/img/aws-ami/2.png, /img/aws-ami/2.png 1.5x, /img/aws-ami/2.png 2x" sizes=auto data-title="Realizando deploy das aplicações" data-alt="Realizando deploy das aplicações" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><strong>Gerando a AMI e encerrando a instância base:</strong></p><p><img loading=lazy src=/img/aws-ami/3.png srcset="/img/aws-ami/3.png, /img/aws-ami/3.png 1.5x, /img/aws-ami/3.png 2x" sizes=auto data-title="Gerando a AMI e encerrando instância" data-alt="Gerando a AMI e encerrando instância" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><strong>AMI gerada no painel da AWS:</strong></p><p><img loading=lazy src=/img/aws-ami/6.png srcset="/img/aws-ami/6.png, /img/aws-ami/6.png 1.5x, /img/aws-ami/6.png 2x" sizes=auto data-title="AMI gerada" data-alt="AMI gerada" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p><strong>Resumo das execuções no Ansible:</strong></p><p><img loading=lazy src=/img/aws-ami/4.png srcset="/img/aws-ami/4.png, /img/aws-ami/4.png 1.5x, /img/aws-ami/4.png 2x" sizes=auto data-title="Resumo das execuções" data-alt="Resumo das execuções" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>Referencia: <a href=http://blog.rolpdog.com/2015/09/manage-stock-windows-amis-with-ansible_3.html target=_blank rel="external nofollow noopener noreferrer">http://blog.rolpdog.com/2015/09/manage-stock-windows-amis-with-ansible_3.html</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="Atualizado em 2019-12-27 17:04:43">Atualizado em 27/12/2019&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/ansible-criado-ami-windows-personalizada-na-aws-parte-2/index.md title="Leia em Markdown" class=link-to-markdown>Leia em Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Compartilhe em Twitter" data-sharer=twitter data-url=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-2/ data-title="Ansible: Criado AMI Windows personalizada na AWS (Parte 2)" data-hashtags=aws,ansible,windows><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Compartilhe em Facebook" data-sharer=facebook data-url=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-2/ data-hashtag=aws><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Compartilhe em Linkedin" data-sharer=linkedin data-url=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-2/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Compartilhe em WhatsApp" data-sharer=whatsapp data-url=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-2/ data-title="Ansible: Criado AMI Windows personalizada na AWS (Parte 2)" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Compartilhe em Evernote" data-sharer=evernote data-url=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-2/ data-title="Ansible: Criado AMI Windows personalizada na AWS (Parte 2)"><i class="fa-brands fa-evernote fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Compartilhe em Trello" data-sharer=trello data-url=https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-2/ data-title="Ansible: Criado AMI Windows personalizada na AWS (Parte 2)" data-description="Na [parte 1](https://sidneiweber.com.br/ansible-criado-ami-windows-personalizada-na-aws-parte-1/) aprendemos como usar um script AWS User Data para configurar uma senha de Administrador e configurar o WinRM no Windows. Agora que sabemos como criar uma instância setando um senha especifica, vamos ao restante dos procedimentos.  Vamos estruturar nosso projeto e manter as coisas organizadas."><i class="fa-brands fa-trello fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/aws/ class=post-tag>aws</a><a href=/tags/ansible/ class=post-tag>ansible</a><a href=/tags/windows/ class=post-tag>windows</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Voltar</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/ansible-criado-ami-windows-personalizada-na-aws-parte-1/ class=post-nav-item rel=prev title="Ansible: Criado AMI Windows personalizada na AWS (Parte 1)"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Ansible: Criado AMI Windows personalizada na AWS (Parte 1)</a>
<a href=/como-redimensionar-volume-ebs-no-linux-sem-downtime/ class=post-nav-item rel=next title="Como redimensionar volume EBS no Linux sem downtime">Como redimensionar volume EBS no Linux sem downtime<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=disqus_thread class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript rel="external nofollow noopener noreferrer">Disqus</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">Possibilitado por <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.117.0">Hugo</a> | Tema - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2009 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/>Sidnei Weber</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label="Voltar ao topo"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label="Ver comentários"><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning></div></noscript></div><script src=https://sidneiweber.disqus.com/embed.js defer></script><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js defer></script><script src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js defer></script><script src=/lib/lunr/lunr.stemmer.support.min.js defer></script><script src=/lib/lunr/lunr.pt.min.js defer></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js async defer></script><script src=https://cdn.jsdelivr.net/npm/typeit@8.7.1/dist/index.umd.js defer></script><script>window.config={code:{copyTitle:"Copiar para a área de transferência",editLockTitle:"Bloquear bloco de código editável",editUnLockTitle:"Desbloqueie o bloco de código editável",editable:!0,maxShownLines:50},comment:{enable:!0,expired:!1},data:{"typeit-header-desktop":"Sidnei Weber","typeit-header-title-mobile":"Sidnei Weber"},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"pt",maxResultLength:10,noResultsFound:"Nenhum resultado encontrado",snippetLength:30,type:"lunr"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"typeit-header-desktop":["typeit-header-desktop"],"typeit-header-title-mobile":["typeit-header-title-mobile"]},duration:-1,loop:!1,speed:100}}</script><script src=/js/theme.min.js defer></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-332343290",{anonymize_ip:!0})</script><script src="https://www.googletagmanager.com/gtag/js?id=G-332343290" async></script></body></html>